<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Test 2 - Sicurezza sul Lavoro</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
 <header>
  <div class="logo" style="display: flex; align-items: center;">
    <img src="logo CFL.png" alt="Logo CFL" class="cfl-logo">
  </div>
  <button onclick="window.location.href='test-selection.html'" class="btn-back btn-small">‚Üê Indietro</button>
</header>


    <main class="test-page">
      <div class="test-header">
        <h2>Test di Apprendimento</h2>
        <p class="test-subtitle">Corso di Formazione Generale dei Lavoratori</p>
        <p class="test-reference">ai sensi dell'articolo 37, comma 1, lettera a) del D.Lgs. 81/08 e dell'Accordo Conferenza Stato Regioni del 21 dicembre 2011</p>
        <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
        <p class="progress-text" id="progressText">Domanda 1 di 8</p>
      </div>

      <div class="test-content">
        <div class="instructions">
          <p><strong>METTERE UNA CROCETTA SU UNA SOLA RISPOSTA PER CIASCUNA DELLE SEGUENTI DOMANDE</strong></p>
        </div>
        <div id="questionContainer"></div>
        <div class="navigation-buttons">
          <button id="prevBtn" class="btn btn-secondary" onclick="previousQuestion()" style="display:none;">‚Üê Indietro</button>
          <button id="nextBtn" class="btn btn-primary" onclick="nextQuestion()">Avanti ‚Üí</button>
          <button id="submitBtn" class="btn btn-primary" onclick="submitTest()" style="display:none;">Invia Test</button>
        </div>
      </div>

      <div id="resultsContainer" style="display:none;">
        <div class="results-card">
          <h2>Risultati Test 2 - Sicurezza</h2>
          <div class="score-circle"><div class="score-number" id="scoreDisplay"></div></div>
          <div id="resultDetails"></div>
          <div class="signature-section">
            <p><strong>COGNOME:</strong> <span id="resultCognome"></span></p>
            <p><strong>NOME:</strong> <span id="resultNome"></span></p>
            <p><strong>DATA:</strong> <span id="resultData"></span></p>
            <div class="signature-area" id="signatureArea" style="display:none;">
              <p><strong>FIRMA:</strong></p>
              <canvas id="signatureCanvas" width="400" height="150"></canvas>

              <button onclick="clearSignature()" class="btn btn-secondary btn-small">üóëÔ∏è Cancella Firma</button>
            </div>
          </div>
          <div class="result-buttons">
            <button id="signAndContinueBtn" class="btn btn-success btn-large" onclick="signAndContinue()" style="display:none;">‚úçÔ∏è Firma e Vai Avanti</button>
            <button id="retryBtn" class="btn btn-warning" onclick="retryWrongQuestions()" style="display:none;">üîÑ Ripeti Domande Sbagliate</button>
            <button onclick="window.location.href='test-selection.html'" class="btn btn-secondary">Torna alla Dashboard</button>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
const questions = [
  {
    question: "La norma che ha riformato, riunito ed armonizzato, abrogando tutte le precedenti normative in materia di igiene e sicurezza nei luoghi di lavoro √®:",
    options: ["D.Lgs. 9 Aprile 2008 n¬∞ 81", "D.Lgs. 19 Settembre 1994 n¬∞ 626", "D.Lgs. 19 Agosto 2005 n¬∞ 187"],
    correct: 0
  },
  {
    question: "Il Testo Unico disciplina:",
    options: ["I rapporti di lavoro subordinato", "La tutela sociale per i lavoratori", "La salute e la sicurezza sui luoghi di lavoro"],
    correct: 2
  },
  {
    question: "Le disposizioni di cui al D.Lgs. n. 81/08 si applicano in tutti i settori di attivit√†, privati o pubblici, nei quali ci sono lavoratori subordinati o ad essi equiparati ed anche autonomi.",
    options: ["Vero", "Falso"],
    correct: 0,
    type: "tf"
  },
  {
    question: "Il lavoratore deve prendersi cura della propria salute e sicurezza, conformemente alle istruzioni e formazioni fornitegli dal Datore di Lavoro.",
    options: ["Vero", "Falso"],
    correct: 0,
    type: "tf"
  },
  {
    question: "Tra i doveri dei Lavoratori vi √® quello di segnalare tempestivamente eventuali deficienze delle attrezzature di lavoro, dei mezzi di protezione collettivi ed individuali:",
    options: ["Vero", "Falso"],
    correct: 0,
    type: "tf"
  },
  {
    question: "L'acronimo DPI significa:",
    options: ["Dispositivi Programmati di Intervento", "Dispositivi di Prevenzione Incendio", "Dispositivi di Protezione Individuale"],
    correct: 2
  },
  {
    question: "Cosa succede se premo questo pulsante situato a ridosso di un'attrezzatura di lavoro? (Il pulsante rosso di emergenza)",
    image: "immagini test 2/pulsante.jpg",
    options: [
      "Viene attivata una sirena d'allarme",
      "Viene interrotta l'alimentazione della macchina la quale si blocca immediatamente",
      "Viene attivato il gruppo di continuit√†"
    ],
    correct: 1
  },
  {
    question: "I ripari, le protezioni ed i dispositivi di sicurezza di un'attrezzatura:",
    options: [
      "Possono essere rimossi o disattivati dal lavoratore a seconda delle esigenze di produzione",
      "Possono essere rimossi o disattivati dal lavoratore solamente con la supervisione del preposto",
      "Non possono in nessun caso essere rimossi o disattivati"
    ],
    correct: 2
  }
];

let currentQuestion = 0, answers = [], questionsToShow = [];
let canvas, ctx, isDrawing = false, hasSignature = false;
let isRetry = false;

function getTestDate(offset = 0) {
  const d = new Date();
  d.setDate(d.getDate() + offset);
  return d.toLocaleDateString('it-IT');
}

function initializeTest() {
  const retryData = localStorage.getItem('test2_retry');
  if (retryData) {
    isRetry = true;
    const wrongIndices = JSON.parse(retryData);
    questionsToShow = wrongIndices.map(idx => questions[idx]);
    localStorage.removeItem('test2_retry');
    document.querySelector('.test-header h2').textContent = 'Test 2 - Ripetizione';
    document.querySelector('.test-subtitle').textContent = 'Rispondi alle domande sbagliate';
  } else {
    questionsToShow = [...questions];
  }
}

function displayQuestion() {
  const q = questionsToShow[currentQuestion];
  const isTF = q.type === 'tf';
  let html = '<div class="question-card"><div class="question-number">' + (currentQuestion + 1) + '</div><h3>' + q.question + '</h3>';
  if(q.image) {
    html += '<div class="question-image"><img src="' + q.image + '" alt="domanda"></div>';
  }
  html += '<div class="options ' + (isTF ? 'true-false-options' : '') + '">';
  q.options.forEach(function(opt, i) {
    html += '<label class="option-label ' + (isTF ? 'tf-option' : '') + '"><input type="radio" name="q' + currentQuestion + '" value="' + i + '"><span class="option-text">' + opt + '</span></label>';
  });
  html += '</div></div>';
  document.getElementById('questionContainer').innerHTML = html;
  updateProgress();
  updateButtons();
}

function nextQuestion() {
  saveAnswer();
  if (currentQuestion < questionsToShow.length - 1) {
    currentQuestion++;
    displayQuestion();
  }
}
function previousQuestion() {
  saveAnswer();
  if (currentQuestion > 0) {
    currentQuestion--;
    displayQuestion();
  }
}
function saveAnswer() {
  const selected = document.querySelector('input[name="q' + currentQuestion + '"]:checked');
  answers[currentQuestion] = selected ? parseInt(selected.value) : null;
}
function updateProgress() {
  const progress = ((currentQuestion + 1) / questionsToShow.length) * 100;
  document.getElementById('progressBar').style.width = progress + '%';
  document.getElementById('progressText').textContent = 'Domanda ' + (currentQuestion + 1) + ' di ' + questionsToShow.length;
}
function updateButtons() {
  document.getElementById('prevBtn').style.display = currentQuestion > 0 ? 'inline-block' : 'none';
  document.getElementById('nextBtn').style.display = currentQuestion < questionsToShow.length - 1 ? 'inline-block' : 'none';
  document.getElementById('submitBtn').style.display = currentQuestion === questionsToShow.length - 1 ? 'inline-block' : 'none';
}
function submitTest() {
  saveAnswer();
  let errors = 0, wrongIndices = [];
  questionsToShow.forEach(function(q, i) {
    if (answers[i] !== q.correct) {
      errors++;
      // Trova l'indice assoluto della domanda originale
      const originIdx = questions.findIndex(orgq => orgq.question === q.question);
      if(originIdx !== -1) wrongIndices.push(originIdx);
    }
  });
  const correct = questionsToShow.length - errors;
  const percentage = Math.round((correct / questionsToShow.length) * 100);
  const passed = errors <= 2;
  const progress = JSON.parse(localStorage.getItem('testProgress') || '{}');
  progress.test2 = {
    errors: errors,
    correct: correct,
    total: questionsToShow.length,
    percentage: percentage,
    passed: passed,
    attempts: (progress.test2 && progress.test2.attempts || 0) + 1,
    date: new Date().toISOString()
  };
  localStorage.setItem('testProgress', JSON.stringify(progress));
  const userData = JSON.parse(localStorage.getItem('userData') || '{}');
  document.querySelector('.test-content').style.display = 'none';
  document.querySelector('.test-header').style.display = 'none';
  document.getElementById('resultsContainer').style.display = 'block';
  document.getElementById('scoreDisplay').textContent = correct + '/' + questionsToShow.length;
  document.getElementById('resultCognome').textContent = userData.cognome || '';
  document.getElementById('resultNome').textContent = userData.nome || '';
  document.getElementById('resultData').textContent = getTestDate(0);

  if (passed) {
    document.getElementById('resultDetails').innerHTML = '<p class="result-percentage">Punteggio: ' + percentage + '%</p><p class="result-status passed">‚úì TEST SUPERATO</p><p class="error-count">Errori: ' + errors + '/2</p><p class="success-message">Ottimo! Firma per proseguire.</p>';
    document.getElementById('signatureArea').style.display = 'block';
    document.getElementById('signAndContinueBtn').style.display = 'block';
    initializeSignatureCanvas();
  } else {
    document.getElementById('resultDetails').innerHTML = '<p class="result-percentage">Punteggio: ' + percentage + '%</p><p class="result-status failed">‚úó TEST NON SUPERATO</p><p class="error-count">Errori: ' + errors + '/2</p><p class="retry-message">‚ö†Ô∏è Devi ripetere le domande sbagliate</p>';
    document.getElementById('retryBtn').style.display = 'block';
    localStorage.setItem('test2_retry', JSON.stringify(wrongIndices));
  }
}
function retryWrongQuestions() {
  window.location.reload();
}
function initializeSignatureCanvas() {
  canvas = document.getElementById('signatureCanvas');
  if (!canvas) return;
  ctx = canvas.getContext('2d');
  ctx.strokeStyle = '#000000';
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  canvas.addEventListener('mousedown', function(e) {
    isDrawing = true;
    hasSignature = true;
    const rect = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
  });
  canvas.addEventListener('mousemove', function(e) {
    if (!isDrawing) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
  });
  canvas.addEventListener('mouseup', function() { isDrawing = false; });
  canvas.addEventListener('mouseout', function() { isDrawing = false; });
  canvas.addEventListener('touchstart', function(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    isDrawing = true;
    hasSignature = true;
    ctx.beginPath();
    ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
  });
  canvas.addEventListener('touchmove', function(e) {
    e.preventDefault();
    if (!isDrawing) return;
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
    ctx.stroke();
  });
  canvas.addEventListener('touchend', function() { isDrawing = false; });
}
function clearSignature() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  hasSignature = false;
}
async function signAndContinue() {
  if (!hasSignature) {
    alert('‚ö†Ô∏è Per favore firma prima di continuare');
    return;
  }
  const progress = JSON.parse(localStorage.getItem('testProgress') || '{}');
  progress.test2.signature = canvas.toDataURL('image/png');
  localStorage.setItem('testProgress', JSON.stringify(progress));

  const userData = JSON.parse(localStorage.getItem('userData') || '{}');
  const data = progress.test2 || {};
  const signatureBase64 = canvas ? canvas.toDataURL('image/png') : "";
  const testResultData = {
    userId: userData.userId || '',
    nome: userData.nome || '',
    cognome: userData.cognome || '',
    email: userData.email || '',
    telefono: userData.telefono || '',
    nomeTest: "Test 2 - Sicurezza sul Lavoro",
    score: data.correct,
    total: data.total,
    percentage: data.percentage,
    stato: data.passed ? "Superato" : "Ripeti",
    date: getTestDate(0),
    firma: signatureBase64,
  };
  await sendTestDataToSheet(testResultData);
  window.location.href = 'test-selection.html';
}
async function sendTestDataToSheet(testResultData) {
  const url = "https://script.google.com/macros/s/AKfycbzvFOMzLJft5ndvsEipmZJWA9YAGNNaRhN08TE0jGFacND__bLsANleDgRzZwq7oF79gQ/exec";
  try {
    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(testResultData),
    });
    const json = await resp.json();
    console.log("Dati inviati:", json);
    return json;
  } catch (err) {
    console.error("Errore invio a Google Sheet:", err);
    return null;
  }
}
initializeTest();
displayQuestion();
</script>
</body>
</html>


